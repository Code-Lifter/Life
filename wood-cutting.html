<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cut Optimizer V5</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --accent: #3498db;
            --waste: #e74c3c;
            --wood: #f1c40f;
            --text: #333;
            --success: #27ae60;
            --shop: #e67e22;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h1 { margin-top: 0; color: var(--primary); text-align: center;}
        h2 { font-size: 1.1rem; margin-bottom: 15px; border-bottom: 2px solid var(--bg-color); padding-bottom: 5px; color: #666; text-transform: uppercase; letter-spacing: 1px;}

        .section { margin-bottom: 30px; }

        /* Settings Grid */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .settings-box { background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .settings-box label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;}
        
        select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;
            background: white; cursor: pointer;
        }

        /* Inputs */
        .input-row {
            display: grid;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            grid-template-columns: 1fr 1fr auto; 
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--primary); color: white; width: 100%; font-size: 1.2rem; padding: 15px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
        
        .btn-secondary { background: #eee; color: #555; width: 100%; border: 1px dashed #ccc;}
        .btn-secondary:hover { background: #e0e0e0; }

        .btn-copy { 
            background: var(--success); color: white; 
            margin-bottom: 10px; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-copy:hover { background: #219150; }

        .btn-remove { 
            background: #ffeded; color: #d63031; 
            padding: 0; width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            border-radius: 6px;
        }
        .btn-remove:hover { background: #ffcccc; }

        /* Results Area */
        #results-area { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; display: none; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: #666; text-transform: uppercase; }

        /* Visuals */
        .group-header {
            margin-top: 30px;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .group-own { background: #e8f5e9; color: #2e7d32; border-left: 5px solid #2e7d32; }
        .group-shop { background: #fff3e0; color: #e67e22; border-left: 5px solid #e67e22; }

        .board-visual {
            margin-bottom: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        .board-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .bar-container {
            height: 50px;
            width: 100%;
            background: #eee;
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .cut-piece {
            background: var(--accent);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            border-right: 1px solid rgba(255,255,255,0.3);
            position: relative;
            cursor: help;
        }
        .cut-piece:hover::after {
            content: attr(data-label);
            position: absolute;
            bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 4px 8px;
            border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 10;
        }

        .kerf-piece { background: #222; height: 100%; width: 2px; opacity: 0.5; }
        .waste-piece {
            background: var(--waste); height: 100%; flex-grow: 1;
            display: flex; align-items: center; justify-content: center; color: white;
            font-size: 0.8rem;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.2) 5px, rgba(255,255,255,0.2) 10px);
        }

        /* TEXT OUTPUT STYLES */
        .text-output-container {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 4px double #eee;
        }
        textarea.job-sheet {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', Courier, monospace;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #2c3e50;
            color: #fff;
            font-size: 0.9rem;
            resize: vertical;
            white-space: pre;
            box-sizing: border-box;
        }

    </style>
</head>
<body>

<div class="container">
    <h1>üìê Smart Cut Optimizer</h1>
    
    <div class="section">
         <input type="text" id="itemName" placeholder="Material / Item Name (e.g. 90x45 Pine)" style="font-size: 1.2rem; font-weight: bold;">
    </div>

    <div class="section settings-grid">
        <div class="settings-box">
            <label>Units:</label>
            <select id="unitSelector" onchange="updatePlaceholders()">
                <option value="mm">Millimeters (mm)</option>
                <option value="cm">Centimeters (cm)</option>
                <option value="m">Meters (m)</option>
            </select>
        </div>
        <div class="settings-box">
            <label>Blade Width (Kerf):</label>
            <input type="number" id="kerf" value="3" placeholder="3">
        </div>
        <div class="settings-box" style="border: 2px solid #e67e22;">
            <label>Store Board Length:</label>
            <input type="number" id="shopStock" value="2400" placeholder="2400">
        </div>
    </div>

    <div class="section">
        <h2>1. Your Stock (Scraps / On Hand)</h2>
        <div id="stock-container"></div>
        <button class="btn-secondary" onclick="addStockRow()">+ Add Stock Size</button>
    </div>

    <div class="section">
        <h2>2. Required Cuts</h2>
        <div id="cuts-container"></div>
        <button class="btn-secondary" onclick="addCutRow()">+ Add Cut Size</button>
    </div>

    <button class="btn-primary" onclick="calculate()">üöÄ Optimize & Generate Sheet</button>

    <div id="results-area">
        <div class="text-output-container">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>üìù Job Sheet (Text Mode)</h2>
                <button class="btn-copy" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            </div>
            <textarea id="text-output" class="job-sheet" readonly></textarea>
        </div>

        <h2 style="margin-top: 40px;">üìä Visual Guide</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-boards">0</div>
                <div class="stat-label">Total Boards</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="boards-to-buy" style="color:#e67e22">0</div>
                <div class="stat-label">Boards to Buy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-waste">0%</div>
                <div class="stat-label">Total Waste</div>
            </div>
        </div>
        
        <div id="visual-output"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        addStockRow(1000); 
        addCutRow(300, 20); 
        updatePlaceholders();
    });

    function getUnit() {
        return document.getElementById('unitSelector').value;
    }

    function updatePlaceholders() {
        const u = getUnit();
        document.querySelectorAll('input[placeholder*="Length"]').forEach(i => i.placeholder = `Length (${u})`);
        
        // Smart Kerf Update
        const k = document.getElementById('kerf');
        if(u === 'm') k.value = 0.003;
        else if(u === 'cm') k.value = 0.3;
        else k.value = 3;
    }

    function addStockRow(len = '') {
        const container = document.getElementById('stock-container');
        const div = document.createElement('div');
        div.className = 'input-row stock-row'; 
        div.innerHTML = `
            <input type="number" placeholder="Length" class="stock-length" value="${len}">
            <input type="number" placeholder="Qty" class="stock-qty" value="1">
            <button class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
        updatePlaceholders();
    }

    function addCutRow(len = '', qty = '') {
        const container = document.getElementById('cuts-container');
        const div = document.createElement('div');
        div.className = 'input-row cut-row'; 
        div.innerHTML = `
            <input type="number" placeholder="Length" class="cut-length" value="${len}">
            <input type="number" placeholder="Qty" class="cut-qty" value="${qty}">
            <button class="btn-remove" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
        updatePlaceholders();
    }

    function calculate() {
        const kerf = parseFloat(document.getElementById('kerf').value) || 0;
        const shopStockLen = parseFloat(document.getElementById('shopStock').value);
        let itemName = document.getElementById('itemName').value;
        if (!itemName || itemName.trim() === "") itemName = "BOARD"; // Default if empty

        const unit = getUnit();

        if(!shopStockLen) { alert("Please set a Store Board Length"); return; }

        // --- Logic: Parse Inputs ---
        let stockOptions = [];
        document.querySelectorAll('.stock-row').forEach(row => {
            const len = parseFloat(row.querySelector('.stock-length').value);
            let qty = parseInt(row.querySelector('.stock-qty').value);
            if (len && len > 0) {
                if (!qty || qty < 0) qty = 1; 
                stockOptions.push({ length: len, qty: qty, source: 'own' });
            }
        });
        stockOptions.sort((a, b) => a.length - b.length);

        let requestedCuts = [];
        document.querySelectorAll('.cut-row').forEach(row => {
            const len = parseFloat(row.querySelector('.cut-length').value);
            const qty = parseInt(row.querySelector('.cut-qty').value);
            if (len && qty > 0) {
                for(let i=0; i<qty; i++) {
                    requestedCuts.push(len);
                }
            }
        });
        
        requestedCuts.sort((a, b) => b - a);

        if (requestedCuts.length === 0) {
            alert("Please add at least one Cut.");
            return;
        }

        // --- Logic: Optimize ---
        let usedBoards = []; 

        for (const cutLen of requestedCuts) {
            let bestBoardIndex = -1;
            
            // Try existing boards
            for (let i = 0; i < usedBoards.length; i++) {
                let spaceNeeded = cutLen;
                if (usedBoards[i].cuts.length > 0) spaceNeeded += kerf;
                if (usedBoards[i].remaining >= spaceNeeded) {
                    bestBoardIndex = i;
                    break;
                }
            }

            if (bestBoardIndex !== -1) {
                let board = usedBoards[bestBoardIndex];
                let spaceNeeded = cutLen + (board.cuts.length > 0 ? kerf : 0);
                board.cuts.push(cutLen);
                board.remaining -= spaceNeeded;
                board.remaining = parseFloat(board.remaining.toFixed(3));
            } else {
                // New board logic
                let chosenStock = null;
                for (let stock of stockOptions) {
                    if (stock.qty > 0 && stock.length >= cutLen) {
                        chosenStock = stock;
                        break; 
                    }
                }

                if (chosenStock) {
                    chosenStock.qty--;
                    usedBoards.push({
                        totalLength: chosenStock.length,
                        remaining: parseFloat((chosenStock.length - cutLen).toFixed(3)),
                        cuts: [cutLen],
                        source: 'own'
                    });
                } else {
                    if (cutLen > shopStockLen) {
                        alert(`Error: Cut (${cutLen}${unit}) is too big for store board ${shopStockLen}${unit}!`);
                        return;
                    }
                    usedBoards.push({
                        totalLength: shopStockLen,
                        remaining: parseFloat((shopStockLen - cutLen).toFixed(3)),
                        cuts: [cutLen],
                        source: 'shop'
                    });
                }
            }
        }

        // --- Render Visuals ---
        renderResults(usedBoards, kerf, unit, itemName);
        
        // --- Render Text Job Sheet ---
        generateTextSheet(usedBoards, itemName, shopStockLen, unit);
    }

    function generateTextSheet(boards, title, shopLen, unit) {
        // Date Formatting
        const now = new Date();
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const dateStr = `${now.getFullYear()}- ${months[now.getMonth()]} - ${String(now.getDate()).padStart(2, '0')}`;
        
        // Time Formatting
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; 
        const timeStr = `${hours}:${minutes} ${ampm}`;

        let text = `ITEM: ${title.toUpperCase()}\n`;
        text += `Date: ${dateStr}\n`;
        text += `Time: ${timeStr}\n`;
        text += `===========================\n\n`;

        const ownBoards = boards.filter(b => b.source === 'own');
        const shopBoards = boards.filter(b => b.source === 'shop');

        if (ownBoards.length > 0) {
            text += `>>> USE EXISTING STOCK (${ownBoards.length} Boards)\n`;
            ownBoards.forEach((b, i) => {
                text += `[ ] ${title.toUpperCase()} #${i+1} (Length: ${b.totalLength}${unit})\n`;
                b.cuts.forEach(cutLen => {
                    text += `    - [ ] Cut: ${cutLen}${unit}\n`;
                });
                text += `    - [ ] Remainder: ${b.remaining}${unit}\n\n`;
            });
        }

        if (shopBoards.length > 0) {
            text += `>>> BUY FROM STORE (${shopBoards.length} Boards @ ${shopLen}${unit})\n`;
            shopBoards.forEach((b, i) => {
                text += `[ ] ${title.toUpperCase()} #${i+1} (NEW)\n`;
                b.cuts.forEach(cutLen => {
                    text += `    - [ ] Cut: ${cutLen}${unit}\n`;
                });
                text += `    - [ ] Remainder: ${b.remaining}${unit}\n\n`;
            });
        }

        text += `===========================\n`;
        text += `Total Parts: ${boards.reduce((acc, b) => acc + b.cuts.length, 0)}\n`;
        text += `End of List`;

        document.getElementById('text-output').value = text;
    }

    function renderResults(boards, kerf, unit, itemName) {
        document.getElementById('results-area').style.display = 'block';
        const visualContainer = document.getElementById('visual-output');
        visualContainer.innerHTML = '';

        let totalMaterial = 0;
        let totalUsedWood = 0;
        let buyCount = 0;

        const ownBoards = boards.filter(b => b.source === 'own');
        const shopBoards = boards.filter(b => b.source === 'shop');

        const renderGroup = (groupBoards, title, cssClass) => {
            if (groupBoards.length === 0) return;
            const header = document.createElement('div');
            header.className = `group-header ${cssClass}`;
            header.innerHTML = `${title} (${groupBoards.length} boards)`;
            visualContainer.appendChild(header);

            groupBoards.forEach((board, index) => {
                if (board.source === 'shop') buyCount++;
                const boardDiv = document.createElement('div');
                boardDiv.className = 'board-visual';
                const wastePercent = ((board.remaining / board.totalLength) * 100).toFixed(1);

                boardDiv.innerHTML = `
                    <div class="board-header">
                        <span>${itemName} #${index + 1} (${board.totalLength}${unit})</span>
                        <span>Remains: ${board.remaining}${unit} (${wastePercent}%)</span>
                    </div>
                `;
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';

                board.cuts.forEach((cutLen, i) => {
                    if (i > 0) {
                        const k = document.createElement('div'); k.className = 'kerf-piece'; 
                        k.style.width = ((kerf / board.totalLength) * 100) + '%'; barContainer.appendChild(k);
                    }
                    const c = document.createElement('div'); c.className = 'cut-piece';
                    c.style.width = ((cutLen / board.totalLength) * 100) + '%'; 
                    c.textContent = cutLen;
                    c.setAttribute('data-label', `${cutLen}${unit}`); 
                    barContainer.appendChild(c);
                    totalUsedWood += cutLen;
                });
                if (board.remaining > 0) {
                    const w = document.createElement('div'); w.className = 'waste-piece';
                    w.textContent = board.remaining; barContainer.appendChild(w);
                }
                boardDiv.appendChild(barContainer); visualContainer.appendChild(boardDiv);
                totalMaterial += board.totalLength;
            });
        };

        renderGroup(ownBoards, "üü¢ Use Your Stock", "group-own");
        renderGroup(shopBoards, "üîµ Buy From Store", "group-shop");

        document.getElementById('total-boards').textContent = boards.length;
        document.getElementById('boards-to-buy').textContent = buyCount;
        
        const totalWaste = totalMaterial - totalUsedWood;
        const totalWastePercent = ((totalWaste / totalMaterial) * 100).toFixed(1);
        document.getElementById('total-waste').textContent = totalWastePercent + '%';
    }

    function copyToClipboard() {
        const copyText = document.getElementById("text-output");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value).then(() => {
            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚úÖ Copied!";
            setTimeout(() => btn.innerHTML = originalText, 2000);
        });
    }
</script>

</body>
</html>