<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthOS v4: The Diagnostic Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        h1, h2, h3, .brand-font { font-family: 'Teko', sans-serif; }
        
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .card-bg { background-color: #1e293b; border: 1px solid #334155; }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; }
        .input-dark:focus { border-color: #fbbf24; outline: none; }
        
        .tab-active { border-bottom: 2px solid #fbbf24; color: #fbbf24; }
        .tab-inactive { color: #94a3b8; border-bottom: 2px solid transparent; }
        
        .gold-glow { text-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
        .egg-fill { transition: height 1s ease-in-out; }
        
        .logic-scroll::-webkit-scrollbar { width: 6px; }
        .logic-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .logic-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .logic-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <nav class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-md border-b border-slate-800 shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üèõÔ∏è</span>
                    <h1 class="text-2xl font-semibold tracking-wide text-white brand-font uppercase">Wealth<span class="text-amber-500">OS</span> <span class="text-xs text-slate-500 align-top">v4</span></h1>
                </div>

                <div class="flex items-center gap-2 bg-slate-800 p-1.5 rounded-lg border border-slate-700 shadow-inner">
                    <div class="flex flex-col px-2">
                        <label class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Age</label>
                        <input type="number" id="in-age" value="30" oninput="updateSystem()" class="w-12 bg-transparent font-bold text-center text-white outline-none brand-font text-xl">
                    </div>
                    <div class="h-8 w-px bg-slate-700"></div>
                    <div class="flex flex-col px-2">
                        <label class="text-[9px] uppercase tracking-widest text-amber-500 font-bold">Retire</label>
                        <input type="number" id="in-retire" value="55" oninput="updateSystem()" class="w-12 bg-transparent font-bold text-center text-amber-500 outline-none brand-font text-xl">
                    </div>
                    <div class="h-8 w-px bg-slate-700"></div>
                    <div class="flex flex-col px-2">
                        <label class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Legacy</label>
                        <input type="number" id="in-death" value="90" oninput="updateSystem()" class="w-12 bg-transparent font-bold text-center text-slate-400 outline-none brand-font text-xl">
                    </div>
                </div>

                <div id="impact-badge" class="hidden md:flex items-center gap-3 bg-slate-950 border border-slate-800 px-4 py-2 rounded-lg">
                    <div class="text-right">
                        <div class="text-[9px] uppercase tracking-widest text-slate-500 font-bold">Freedom Crossover</div>
                        <div class="text-xs text-slate-400">Projected: Age <span id="val-crossover-age" class="text-emerald-500 font-bold font-mono text-base">--</span></div>
                    </div>
                </div>

            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 mt-8">

        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
            <div class="card-bg p-4 rounded-xl shadow-lg">
                <label class="block text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">Net Worth</label>
                <div class="flex items-center text-white text-xl font-bold font-mono">
                    $<input type="number" id="in-worth" value="50000" oninput="updateSystem()" class="bg-transparent w-full outline-none placeholder-slate-700">
                </div>
            </div>
            <div class="card-bg p-4 rounded-xl shadow-lg border-b-2 border-emerald-500/50">
                <label class="block text-[10px] uppercase tracking-widest text-emerald-500 font-bold mb-1">Monthly Savings</label>
                <div class="flex items-center text-emerald-400 text-xl font-bold font-mono">
                    +$<input type="number" id="in-save" value="2000" oninput="updateSystem()" class="bg-transparent w-full outline-none placeholder-emerald-900">
                </div>
            </div>
            <div class="card-bg p-4 rounded-xl shadow-lg border-b-2 border-red-500/50">
                <label class="block text-[10px] uppercase tracking-widest text-red-500 font-bold mb-1">Monthly Spend</label>
                <div class="flex items-center text-red-400 text-xl font-bold font-mono">
                    -$<input type="number" id="in-spend" value="4000" oninput="updateSystem()" class="bg-transparent w-full outline-none placeholder-red-900">
                </div>
            </div>
            <div class="card-bg p-4 rounded-xl shadow-lg">
                <label class="block text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">Return (%)</label>
                <div class="flex items-center text-blue-400 text-xl font-bold font-mono">
                    %<input type="number" id="in-return" value="7" oninput="updateSystem()" class="bg-transparent w-full outline-none placeholder-blue-900">
                </div>
            </div>
            <div class="card-bg p-4 rounded-xl shadow-lg border-amber-500/30 bg-amber-900/10">
                <label class="block text-[10px] uppercase tracking-widest text-amber-500 font-bold mb-1">Inflation (%)</label>
                <div class="flex items-center text-amber-400 text-xl font-bold font-mono">
                    %<input type="number" id="in-inflation" value="3" oninput="updateSystem()" class="bg-transparent w-full outline-none placeholder-amber-900">
                </div>
            </div>
        </div>

        <div class="flex border-b border-slate-800 mb-8 overflow-x-auto hide-scrollbar">
            <button onclick="switchTab('action')" id="tab-btn-action" class="tab-active px-6 py-3 font-bold uppercase text-sm tracking-wider transition-colors whitespace-nowrap">
                üéØ Action Plan
            </button>
            <button onclick="switchTab('egg')" id="tab-btn-egg" class="tab-inactive px-6 py-3 font-bold uppercase text-sm tracking-wider transition-colors whitespace-nowrap">
                ü•ö The Golden Egg
            </button>
            <button onclick="switchTab('growth')" id="tab-btn-growth" class="tab-inactive px-6 py-3 font-bold uppercase text-sm tracking-wider transition-colors whitespace-nowrap">
                üìà Growth Engine
            </button>
            <button onclick="switchTab('drawdown')" id="tab-btn-drawdown" class="tab-inactive px-6 py-3 font-bold uppercase text-sm tracking-wider transition-colors whitespace-nowrap">
                üìâ The Reality Check
            </button>
        </div>

        <div id="view-action" class="fade-in">
            <div class="max-w-4xl mx-auto space-y-6">
                
                <div class="text-center mb-8">
                    <h2 class="text-4xl text-white font-bold brand-font mb-2">The Diagnosis</h2>
                    <p class="text-slate-400">Your numbers have been analyzed. Here is your primary directive.</p>
                </div>

                <div id="diagnosis-container" class="card-bg p-8 rounded-3xl border-2 relative overflow-hidden shadow-2xl">
                    <div id="diagnosis-bg-glow" class="absolute -top-32 -right-32 w-96 h-96 rounded-full blur-3xl opacity-20 pointer-events-none"></div>
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-4">
                            <div id="diagnosis-icon" class="text-5xl">üîç</div>
                            <div>
                                <h3 id="diagnosis-title" class="text-3xl text-white font-bold brand-font tracking-wide uppercase">Analyzing...</h3>
                                <div id="diagnosis-subtitle" class="text-xs font-bold uppercase tracking-widest mt-1">Status Report</div>
                            </div>
                        </div>
                        
                        <div class="h-px w-full bg-slate-700/50 my-6"></div>
                        
                        <p id="diagnosis-body" class="text-lg text-slate-300 leading-relaxed">
                            Awaiting data input...
                        </p>

                        <div id="diagnosis-metrics" class="mt-8 grid grid-cols-2 gap-4 hidden">
                            </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="view-egg" class="hidden fade-in space-y-8">
            <div class="grid md:grid-cols-3 gap-8 items-start">
                <div class="col-span-1 flex flex-col items-center justify-center card-bg rounded-2xl p-8 relative shadow-lg">
                    <div class="w-48 h-60 rounded-[50%/60%_60%_40%_40%] border-4 border-slate-700 relative overflow-hidden bg-slate-900 shadow-inner">
                        <div id="egg-fill" class="absolute bottom-0 w-full bg-gradient-to-t from-amber-600 to-amber-400 egg-fill flex items-center justify-center" style="height: 0%">
                            <div class="w-full h-1 bg-white/20 absolute top-0"></div>
                        </div>
                        <div class="absolute inset-0 flex items-center justify-center z-10 mix-blend-difference">
                            <span id="egg-percent" class="text-4xl font-black text-white brand-font">0%</span>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-4 uppercase tracking-widest font-bold">Progress to Target</p>
                </div>

                <div class="col-span-2 card-bg p-6 rounded-2xl h-[360px] flex flex-col shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 class="text-2xl text-white font-bold brand-font">Freedom Trajectory</h2>
                            <p class="text-slate-400 text-xs mt-1">Green Line = Your Wealth. Gold Line = 25x Annual Spend (Moving Target).</p>
                        </div>
                        <div class="text-right hidden md:block">
                            <span class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Target at Age <span id="txt-retire-age-chart">55</span></span>
                            <div id="val-chart-target" class="text-xl font-mono font-bold text-amber-500">$0</div>
                        </div>
                    </div>
                    <div class="flex-grow relative">
                        <canvas id="freedomChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="card-bg p-6 rounded-2xl border-l-4 border-amber-500 shadow-lg">
                        <div class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-1">Adjusted Freedom Number</div>
                        <div class="flex items-baseline gap-2">
                            <span id="val-target" class="text-4xl font-black text-white brand-font tracking-tight gold-glow">$0</span>
                        </div>
                        <div class="text-xs text-slate-500 mt-2">
                            To spend <b>$<span id="txt-spend">4,000</span></b> (today's value) when you retire, you will need this amount to account for <span id="txt-years-to-retire">0</span> years of inflation.
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card-bg p-4 rounded-xl shadow-lg">
                            <span class="block text-[10px] uppercase text-slate-500 font-bold">Current</span>
                            <span id="val-current" class="text-xl text-white font-mono font-bold">$0</span>
                        </div>
                        <div class="card-bg p-4 rounded-xl shadow-lg">
                            <span class="block text-[10px] uppercase text-slate-500 font-bold">The Gap</span>
                            <span id="val-gap" class="text-xl text-red-400 font-mono font-bold">$0</span>
                        </div>
                    </div>
                </div>

                <div class="card-bg p-6 rounded-2xl h-64 overflow-y-auto logic-scroll shadow-lg border border-slate-700/50">
                    <h3 class="text-white font-bold brand-font text-lg mb-3 flex items-center gap-2">
                        <span class="text-lg">ü¶â</span> The 4% Rule: No Fluff
                    </h3>
                    <div class="space-y-4 text-xs text-slate-400 leading-relaxed">
                        <div>
                            <strong class="text-slate-200 block mb-1">1. The Core Idea</strong>
                            It's a heuristic, not a law. You invest a lump sum (The Egg). You withdraw 4% in Year 1. You increase that amount by inflation every year. Historically, this lasts 30 years.
                        </div>
                        <div>
                            <strong class="text-slate-200 block mb-1">2. The "Golden Egg"</strong>
                            The egg is the capital. You eat the growth, not the goose. If you kill the goose (withdraw too much early), the math fails.
                        </div>
                        <div>
                            <strong class="text-slate-200 block mb-1">3. The Assumptions</strong>
                            <ul class="list-disc pl-4 mt-1 space-y-1">
                                <li><strong>Asset Allocation:</strong> Typically 50-75% stocks, the rest bonds. No cash under the mattress.</li>
                                <li><strong>Horizon:</strong> Designed for 30 years. If you are FIRE (40+ years), 4% is risky. Many use 3.5%.</li>
                            </ul>
                        </div>
                        <div>
                            <strong class="text-slate-200 block mb-1">4. The Takeaway</strong>
                            Annual Spend x 25 = Required Capital. <br>
                            It is a starting assumption, not a promise. Flexibility is the only guarantee.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-growth" class="hidden fade-in space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl text-white font-bold brand-font">Compound Growth vs Inflation</h2>
                    <p class="text-slate-400 text-sm">Blue line must beat the dotted line (Inflation) to build real wealth.</p>
                </div>
                <div class="text-right">
                    <div class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Projected Nominal Total</div>
                    <div id="val-projected" class="text-3xl font-black text-emerald-400 brand-font">$0</div>
                </div>
            </div>
            <div class="card-bg p-4 rounded-xl h-[400px] shadow-lg">
                <canvas id="growthChart"></canvas>
            </div>
        </div>

        <div id="view-drawdown" class="hidden fade-in space-y-6">
             <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-2xl text-white font-bold brand-font">Legacy Simulator</h2>
                    <p class="text-slate-400 text-sm">Simulating spending increasing by <span id="txt-inflation-rate">3</span>% every year.</p>
                </div>
                 <div class="text-right">
                    <div class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Safety Margin</div>
                    <div id="val-safety" class="text-xl font-bold text-white brand-font">--</div>
                </div>
            </div>
             <div class="card-bg p-4 rounded-xl h-[300px] shadow-lg">
                <canvas id="drawdownChart"></canvas>
            </div>
            <div id="alert-zone" class="hidden bg-red-900/20 border border-red-500/50 p-4 rounded-lg flex items-start gap-3 shadow-lg">
                <span class="text-2xl">‚ö†Ô∏è</span>
                <div>
                    <h4 class="text-red-400 font-bold uppercase text-sm tracking-wide">Ran Out of Money</h4>
                    <p class="text-red-200/70 text-xs mt-1">Inflation ate your savings at Age <span id="val-broke-age" class="font-bold text-white">0</span>.</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        let chartInstance = null;
        let drawdownChartInstance = null;
        let freedomChartInstance = null;

        window.onload = function() { updateSystem(); };

        function getInputs() {
            return {
                age: parseInt(document.getElementById('in-age').value) || 0,
                retire: parseInt(document.getElementById('in-retire').value) || 0,
                death: parseInt(document.getElementById('in-death').value) || 0,
                worth: parseFloat(document.getElementById('in-worth').value) || 0,
                save: parseFloat(document.getElementById('in-save').value) || 0,
                spend: parseFloat(document.getElementById('in-spend').value) || 0,
                roi: parseFloat(document.getElementById('in-return').value) / 100 || 0,
                inf: parseFloat(document.getElementById('in-inflation').value) / 100 || 0,
            };
        }

        function formatMoney(num) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
        }

        function updateSystem() {
            const data = getInputs();
            const yearsToGrow = Math.max(0, data.retire - data.age);
            
            // Core Math
            const inflationMultiplier = Math.pow(1 + data.inf, yearsToGrow);
            const futureMonthlySpend = data.spend * inflationMultiplier;
            const futureAnnualSpend = futureMonthlySpend * 12;
            const freedomNumber = futureAnnualSpend * 25; 

            let simWorth = data.worth;
            for(let i=0; i<yearsToGrow; i++) {
                const currentMonthlySave = data.save * Math.pow(1 + data.inf, i);
                simWorth = (simWorth + (currentMonthlySave * 12)) * (1 + data.roi);
            }

            const pct = Math.min(100, Math.max(0, (simWorth / freedomNumber) * 100));
            const gap = freedomNumber - simWorth;

            // Update Diagnosic Engine (Action Plan)
            runDiagnosticEngine(data, simWorth, freedomNumber, yearsToGrow, gap);

            // Update Egg Tab Text
            document.getElementById('txt-spend').innerText = data.spend.toLocaleString();
            document.getElementById('txt-years-to-retire').innerText = yearsToGrow;
            document.getElementById('txt-retire-age-chart').innerText = data.retire;
            document.getElementById('val-target').innerText = formatMoney(freedomNumber);
            document.getElementById('val-chart-target').innerText = formatMoney(freedomNumber);
            document.getElementById('val-current').innerText = formatMoney(simWorth);
            document.getElementById('val-gap').innerText = gap > 0 ? formatMoney(gap) : "$0";
            document.getElementById('egg-fill').style.height = `${pct}%`;
            document.getElementById('egg-percent').innerText = `${Math.round(pct)}%`;

            // Charts Math
            const freedomLabels = [];
            const wealthSeries = [];
            const targetSeries = [];
            let chartWorth = data.worth;
            let crossoverAge = null;
            const chartYears = (data.retire - data.age) + 5; 

            for(let i=0; i <= chartYears; i++) {
                const currentAge = data.age + i;
                freedomLabels.push(currentAge);
                wealthSeries.push(chartWorth);
                
                const yearSpend = (data.spend * 12) * Math.pow(1 + data.inf, i);
                const yearTarget = yearSpend * 25;
                targetSeries.push(yearTarget);

                if (chartWorth >= yearTarget && crossoverAge === null) crossoverAge = currentAge;

                if (currentAge < data.retire) {
                    const yearSave = (data.save * 12) * Math.pow(1 + data.inf, i);
                    chartWorth = (chartWorth + yearSave) * (1 + data.roi);
                } else {
                    chartWorth = (chartWorth - yearSpend) * (1 + data.roi);
                }
            }

            const crossEl = document.getElementById('val-crossover-age');
            if(crossoverAge) {
                crossEl.innerText = crossoverAge;
                if(crossoverAge <= data.retire) crossEl.className = "text-emerald-500 font-bold font-mono text-base";
                else crossEl.className = "text-amber-500 font-bold font-mono text-base";
            } else {
                crossEl.innerText = "Never";
                crossEl.className = "text-red-500 font-bold font-mono text-base";
            }

            renderFreedomChart(freedomLabels, wealthSeries, targetSeries, data.retire);

            const growthLabels = [];
            const growthData = [];
            const infData = [];
            let gWorth = data.worth;

            for(let i = 0; i <= yearsToGrow; i++) {
                growthLabels.push(data.age + i);
                growthData.push(gWorth);
                const yearSave = (data.save * 12) * Math.pow(1 + data.inf, i);
                gWorth = (gWorth + yearSave) * (1 + data.roi);
                infData.push((data.spend * 12 * Math.pow(1+data.inf, i)) * 25);
            }
            document.getElementById('val-projected').innerText = formatMoney(gWorth);
            renderGrowthChart(growthLabels, growthData, infData);

            const drawLabels = [];
            const drawData = [];
            const yearsToLive = data.death - data.retire;
            let dWorth = gWorth;
            let brokeAge = null;
            let dSpend = futureAnnualSpend;

            for(let i = 0; i <= yearsToLive; i++) {
                const age = data.retire + i;
                drawLabels.push(age);
                drawData.push(Math.max(0, dWorth));
                if (dWorth <= 0 && brokeAge === null) brokeAge = age;
                
                dWorth = (dWorth - dSpend) * (1 + data.roi);
                dSpend = dSpend * (1 + data.inf);
            }

            document.getElementById('txt-inflation-rate').innerText = data.inf * 100;
            renderDrawdownChart(drawLabels, drawData);
            
             if (brokeAge) {
                document.getElementById('val-safety').innerText = "FAILED";
                document.getElementById('val-safety').className = "text-xl font-bold text-red-500 brand-font";
                document.getElementById('alert-zone').classList.remove('hidden');
                document.getElementById('val-broke-age').innerText = brokeAge;
            } else {
                document.getElementById('val-safety').innerText = "SECURE";
                document.getElementById('val-safety').className = "text-xl font-bold text-emerald-500 brand-font";
                document.getElementById('alert-zone').classList.add('hidden');
            }
        }

        // --- DIAGNOSTIC ENGINE LOGIC ---
        function runDiagnosticEngine(data, simWorth, freedomNumber, yearsToGrow, gap) {
            const container = document.getElementById('diagnosis-container');
            const icon = document.getElementById('diagnosis-icon');
            const title = document.getElementById('diagnosis-title');
            const subtitle = document.getElementById('diagnosis-subtitle');
            const body = document.getElementById('diagnosis-body');
            const glow = document.getElementById('diagnosis-bg-glow');
            const metrics = document.getElementById('diagnosis-metrics');
            
            metrics.innerHTML = ""; // reset
            metrics.classList.remove('hidden');

            // 1. CLEAR FOR TAKEOFF (On track)
            if (gap <= 0) {
                container.className = "card-bg p-8 rounded-3xl border-2 border-emerald-500/50 relative overflow-hidden shadow-[0_0_30px_rgba(16,185,129,0.15)]";
                glow.className = "absolute -top-32 -right-32 w-96 h-96 rounded-full blur-3xl opacity-20 pointer-events-none bg-emerald-500";
                icon.innerText = "üöÄ";
                title.innerText = "Clear for Takeoff";
                title.className = "text-3xl text-emerald-400 font-bold brand-font tracking-wide uppercase";
                subtitle.innerText = "Status: On Track";
                subtitle.className = "text-xs font-bold uppercase tracking-widest mt-1 text-emerald-500/70";
                
                body.innerHTML = `Your current trajectory exceeds your required freedom number. You are projected to hit <b>${formatMoney(simWorth)}</b> by age ${data.retire}. <br><br><b>Primary Directive:</b> Keep doing exactly what you are doing. Your biggest risk right now is lifestyle creep. Do not increase your monthly spending without a massive proportional increase in income.`;
                return;
            }

            // 2. THE HORIZON PROBLEM (Saving aggressively, but timeline too short)
            if (yearsToGrow < 10 && data.save >= (data.spend * 0.5)) {
                container.className = "card-bg p-8 rounded-3xl border-2 border-blue-500/50 relative overflow-hidden shadow-[0_0_30px_rgba(59,130,246,0.15)]";
                glow.className = "absolute -top-32 -right-32 w-96 h-96 rounded-full blur-3xl opacity-20 pointer-events-none bg-blue-500";
                icon.innerText = "‚è≥";
                title.innerText = "The Horizon Problem";
                title.className = "text-3xl text-blue-400 font-bold brand-font tracking-wide uppercase";
                subtitle.innerText = "Status: Math Check";
                subtitle.className = "text-xs font-bold uppercase tracking-widest mt-1 text-blue-500/70";

                body.innerHTML = `You are saving aggressively (<b>${formatMoney(data.save)}/mo</b>), but you are trying to force compounding without giving it time. You cannot out-earn a ${yearsToGrow}-year timeline without massive risk.<br><br><b>Primary Directive:</b> Delay your freedom gate. Let compounding do the heavy lifting for you.`;
                return;
            }

            // 3. THE BURN RATE (High spend, double-whammy opportunity)
            if (data.spend > 4000 || data.save < (data.spend * 0.3)) {
                container.className = "card-bg p-8 rounded-3xl border-2 border-amber-500/50 relative overflow-hidden shadow-[0_0_30px_rgba(251,191,36,0.15)]";
                glow.className = "absolute -top-32 -right-32 w-96 h-96 rounded-full blur-3xl opacity-20 pointer-events-none bg-amber-500";
                icon.innerText = "üî•";
                title.innerText = "The Burn Rate";
                title.className = "text-3xl text-amber-400 font-bold brand-font tracking-wide uppercase";
                subtitle.innerText = "Status: Efficiency Leak";
                subtitle.className = "text-xs font-bold uppercase tracking-widest mt-1 text-amber-500/70";

                const cutAmount = data.spend * 0.10; // 10% cut
                const newFutureSpend = (data.spend - cutAmount) * Math.pow(1 + data.inf, yearsToGrow);
                const newTarget = newFutureSpend * 12 * 25;
                const targetReduction = freedomNumber - newTarget;

                body.innerHTML = `Your target egg is massive because your lifestyle is expensive. You need a "Double Whammy" effect. <br><br><b>Primary Directive:</b> Cut your monthly spend by just 10% (<b>${formatMoney(cutAmount)}</b>) and add it to your savings. Look at the math below‚Äîthis one small cut dramatically slashes your required goal.`;
                
                metrics.innerHTML = `
                    <div class="bg-slate-900 border border-slate-700 p-4 rounded-xl">
                        <span class="block text-[10px] uppercase text-slate-500 font-bold">New Monthly Spend</span>
                        <span class="text-2xl text-white font-mono font-bold">${formatMoney(data.spend - cutAmount)}</span>
                    </div>
                    <div class="bg-amber-900/20 border border-amber-500/30 p-4 rounded-xl">
                        <span class="block text-[10px] uppercase text-amber-500/70 font-bold">Target Drops By</span>
                        <span class="text-2xl text-amber-400 font-mono font-bold">${formatMoney(targetReduction)}</span>
                    </div>
                `;
                return;
            }

            // 4. THE SPADE (Lean spend, but low income/savings)
            if (data.spend <= 4000 && data.save < 2000) {
                container.className = "card-bg p-8 rounded-3xl border-2 border-purple-500/50 relative overflow-hidden shadow-[0_0_30px_rgba(168,85,247,0.15)]";
                glow.className = "absolute -top-32 -right-32 w-96 h-96 rounded-full blur-3xl opacity-20 pointer-events-none bg-purple-500";
                icon.innerText = "‚õèÔ∏è";
                title.innerText = "The Spade";
                title.className = "text-3xl text-purple-400 font-bold brand-font tracking-wide uppercase";
                subtitle.innerText = "Status: Income Ceiling";
                subtitle.className = "text-xs font-bold uppercase tracking-widest mt-1 text-purple-500/70";

                body.innerHTML = `You can't frugality your way out of this gap. Your spending is already relatively lean (<b>${formatMoney(data.spend)}/mo</b>), but your contribution rate is too low. <br><br><b>Primary Directive:</b> Stop clipping coupons. Your sole focus must be increasing your top-line income (a new job, promotion, or side-hustle) and sweeping 100% of the new money directly into investments. You need a bigger shovel.`;
                return;
            }

            // Fallback
            container.className = "card-bg p-8 rounded-3xl border-2 border-slate-500/50 relative overflow-hidden";
            glow.className = "absolute -top-32 -right-32 w-96 h-96 rounded-full blur-3xl opacity-20 pointer-events-none bg-slate-500";
            icon.innerText = "‚öôÔ∏è";
            title.innerText = "Increase Velocity";
            title.className = "text-3xl text-slate-200 font-bold brand-font tracking-wide uppercase";
            subtitle.innerText = "Status: Grind Phase";
            subtitle.className = "text-xs font-bold uppercase tracking-widest mt-1 text-slate-500";
            body.innerHTML = "You are in the accumulation grind. Keep increasing your savings rate with every pay raise, and keep your investments automated.";
        }

        // --- Renderers ---

        function renderFreedomChart(labels, wealth, target, retireAge) {
            const ctx = document.getElementById('freedomChart').getContext('2d');
            if (freedomChartInstance) freedomChartInstance.destroy();

            freedomChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Your Wealth', data: wealth, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: true },
                        { label: 'Moving Target', data: target, borderColor: '#fbbf24', borderWidth: 3, borderDash: [5, 5], tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#94a3b8', font: {size: 10} } } },
                    scales: { x: { grid: { color: '#1e293b' }, ticks: { color: '#64748b' } }, y: { grid: { color: '#1e293b' }, ticks: { color: '#64748b', callback: (val) => '$' + val/1000 + 'k' } } }
                }
            });
        }

        function renderGrowthChart(labels, totalData, targetData) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Projected Wealth', data: totalData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0 },
                        { label: 'Inflation Baseline', data: targetData, borderColor: '#ef4444', borderWidth: 1, borderDash: [2, 2], pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { x: { grid: { color: '#1e293b' } }, y: { grid: { color: '#1e293b' } } },
                    plugins: { legend: { labels: { color: '#94a3b8' } } }
                }
            });
        }

        function renderDrawdownChart(labels, data) {
            const ctx = document.getElementById('drawdownChart').getContext('2d');
            if (drawdownChartInstance) drawdownChartInstance.destroy();
            const hitsZero = data.includes(0);
            drawdownChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Portfolio', data: data, borderColor: hitsZero ? '#ef4444' : '#10b981', backgroundColor: hitsZero ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: { x: { grid: { color: '#1e293b' } }, y: { grid: { color: '#1e293b' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-btn-"]').forEach(el => el.className = "tab-inactive px-6 py-3 font-bold uppercase text-sm tracking-wider transition-colors whitespace-nowrap cursor-pointer");
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).className = "tab-active px-6 py-3 font-bold uppercase text-sm tracking-wider transition-colors whitespace-nowrap cursor-pointer";
            
            setTimeout(updateSystem, 50);
        }
    </script>
</body>
</html>